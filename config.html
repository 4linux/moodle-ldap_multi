<?php

// Set to defaults if undefined
if (!isset($config->host_url)) {
    $config->host_url = '';
}
if (!isset($config->start_tls)) {
    $config->start_tls = false;
}
if (empty($config->ldapencoding)) {
    $config->ldapencoding = 'utf-8';
}
if (!isset($config->pagesize)) {
    $config->pagesize = LDAP_DEFAULT_PAGESIZE;
}
if (!isset($config->contexts)) {
    $config->contexts = '';
}
if (!isset($config->user_type)) {
    $config->user_type = 'default';
}
if (!isset($config->user_attribute)) {
    $config->user_attribute = '';
}
if (!isset($config->suspended_attribute)) {
    $config->suspended_attribute = '';
}
if (!isset($config->sync_suspended)) {
    $config->sync_suspended = '';
}
if (!isset($config->search_sub)) {
    $config->search_sub = '';
}
if (!isset($config->opt_deref)) {
    $config->opt_deref = LDAP_DEREF_NEVER;
}
if (!isset($config->preventpassindb)) {
    $config->preventpassindb = 0;
}
if (!isset($config->bind_dn)) {
    $config->bind_dn = '';
}
if (!isset($config->bind_pw)) {
    $config->bind_pw = '';
}
if (!isset($config->ldap_version)) {
    $config->ldap_version = '3';
}
if (!isset($config->objectclass)) {
    $config->objectclass = '';
}
if (!isset($config->memberattribute)) {
    $config->memberattribute = '';
}
if (!isset($config->memberattribute_isdn)) {
    $config->memberattribute_isdn = '';
}
if (!isset($config->creators)) {
    $config->creators = '';
}
if (!isset($config->create_context)) {
    $config->create_context = '';
}
if (!isset($config->expiration)) {
    $config->expiration = '';
}
if (!isset($config->expiration_warning)) {
    $config->expiration_warning = '10';
}
if (!isset($config->expireattr)) {
    $config->expireattr = '';
}
if (!isset($config->gracelogins)) {
    $config->gracelogins = '';
}
if (!isset($config->graceattr)) {
    $config->graceattr = '';
}
if (!isset($config->auth_user_create)) {
    $config->auth_user_create = '';
}
if (!isset($config->forcechangepassword)) {
    $config->forcechangepassword = 0;
}
if (!isset($config->stdchangepassword)) {
    $config->stdchangepassword = 0;
}
if (!isset($config->passtype)) {
    $config->passtype = 'plaintext';
}
if (!isset($config->changepasswordurl)) {
    $config->changepasswordurl = '';
}
if (!isset($config->removeuser)) {
    $config->removeuser = AUTH_REMOVEUSER_KEEP;
}
if (!isset($config->ntlmsso_enabled)) {
    $config->ntlmsso_enabled = 0;
}
if (!isset($config->ntlmsso_subnet)) {
    $config->ntlmsso_subnet = '';
}
if (!isset($config->ntlmsso_ie_fastpath)) {
    $config->ntlmsso_ie_fastpath = 0;
}
if (!isset($config->ntlmsso_type)) {
    $config->ntlmsso_type = 'ntlm';
}
if (!isset($config->ntlmsso_remoteuserformat)) {
    $config->ntlmsso_remoteuserformat = '';
}

$yesno = array(get_string('no'), get_string('yes'));

$fastpathoptions = array(AUTH_NTLM_FASTPATH_YESFORM => get_string('auth_ntlmsso_ie_fastpath_yesform', 'auth_ldap_multi'),
                         AUTH_NTLM_FASTPATH_YESATTEMPT => get_string('auth_ntlmsso_ie_fastpath_yesattempt', 'auth_ldap_multi'),
                         AUTH_NTLM_FASTPATH_ATTEMPT => get_string('auth_ntlmsso_ie_fastpath_attempt', 'auth_ldap_multi'));

$disabled = '';
$pagedresultssupported = false;

if ($config->host_url !== '') {
    /**
     * We try to connect each and every time we open the config, because we want to set the Page
     * Size setting as enabled or disabled depending on the configured LDAP server supporting
     * pagination or not, and to notify the user about it. If the user changed the LDAP server (or
     * the LDAP protocol version) last time, it might happen that paged results are no longer
     * available and we want to show that to the user the next time she goes to the settings page.
     */
    try {
		$numberOfServers = count(json_decode($config->host_url));
		$ldapconn = [];
		$hosts = json_decode($this->config->host_url);
        $verstions = json_decode($this->config->ldap_version);
        $types = json_decode($this->config->user_type);
        $bindsDn = json_decode($this->config->bind_dn);
        $bindsPw = json_decode($this->config->bind_pw);
        $optsDeref = json_decode($this->config->opt_deref);
        $startsTls = json_decode($this->config->start_tls);

		if(isset($_GET['id'])){
			$id = $_GET['id'];
			$optsDeref[$id] = isset($optsDeref[$id]) ? $optsDeref[$id] : 0;

			$ldapconn[$id] = $this->ldap_connect($hosts[$id], 
												 $verstions[$id], 
												 $types[$id], 
												 $bindsDn[$id], 
												 $bindsPw[$id], 
												 $optsDeref[$id], 
												 $startsTls[$id]);
		 }
    } catch (Exception $e) {
        // If we couldn't connect and get the supported options, we can only assume we don't support paged results.
        $pagedresultssupported = false;
    }
}

/* Make sure we only disable the paged result size setting and show the notification about it if
 * there is a configured server that we tried to contact.  Othersiwe, if someone's LDAP server does
 * support paged results, they won't be able to turn it on the first time they set it up (because
 * the field will be disabled).
 */
if (($config->host_url !== '') && (!$pagedresultssupported)) {
    $disabled = ' disabled="disabled"';
    echo $OUTPUT->notification(get_string('pagedresultsnotsupp', 'auth_ldap_multi'), \core\output\notification::NOTIFY_INFO);
}

$countServers = count(json_decode($config->host_url));

if($countServers < 1){
	$countServers = 1;
}

?>

    <style>
        .container {
            width: 100%;
            border: 1px solid #d3d3d3;
            padding: 0 !important;
        }
        
        .container div {
            width: 100%;
        }
        
        .container .header {
            padding: 2px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .container .content {
            display: none;
            padding: 5px;
        }
        
        .notconected{
			color: black;
        }
        
        .conected{
			color: green;
        }
    </style>

    <div class="container">
		<?php for($x = 0; $x < $countServers; $x++): ?>
        <div class="header <?= is_resource($ldapconn[$x]) ? 'conected' : 'notconected' ?>" id="header<?=$x?>">
            <?php print_string('auth_ldap_multi_server_settings', 'auth_ldap_multi') ?> +
        </div>
        <div class="content" id="content<?=$x?>">
            <table cellspacing="0" cellpadding="5" border="0">
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="host_url"><?php print_string('auth_ldap_multi_host_url_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $host_url = json_decode($config->host_url); ?>
                        <input name="host_url[]" id="host_url" type="text" class="text-ltr" size="30" value="<?php echo $host_url[$x] ?>" />
                        <?php if (isset($err['host_url'])) { echo $OUTPUT->error_text($err['host_url']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_host_url', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="ldap_version"><?php print_string('auth_ldap_multi_version_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                        <?php
                        	$ldap_version = json_decode($config->ldap_version);
           					$versions = array();
           					$versions[2] = '2';
           					$versions[3] = '3';
           					echo html_writer::select($versions, 'ldap_version[]', $ldap_version[$x], false);
           					if (isset($err['ldap_version'])) { echo $OUTPUT->error_text($err['ldap_version']); }
       					?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_version', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top">
                    <td align="right">
                        <label for="start_tls"><?php print_string('start_tls_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $start_tls = json_decode($config->start_tls); ?>
                        <?php echo html_writer::select($yesno, 'start_tls[]', $start_tls[$x], false); ?>
                    </td>
                    <td>
                        <?php print_string('start_tls', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="ldapencoding"><?php print_string('auth_ldap_multi_ldap_encoding_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $ldapencoding = json_decode($config->ldapencoding); ?>
                        <input id="ldapencoding" name="ldapencoding[]" type="text" class="text-ltr" value="<?php echo $ldapencoding[$x] ?>" />
                        <?php if (isset($err['ldapencoding'])) { echo $OUTPUT->error_text($err['ldapencoding']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_ldap_encoding', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top">
                    <td align="right">
                        <label for="pagesize"><?php print_string('pagesize_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $pagesize = json_decode($config->pagesize); ?>
                        <input id="pagesize" name="pagesize[]" type="text" class="text-ltr" value="<?php echo $pagesize[$x] ?>" <?php echo $disabled ?> />
                        <?php
            				if (isset($err['pagesize'])) { echo $OUTPUT->error_text($err['pagesize']); }
            				if ($disabled) {
               					 // Don't loose the page size value (disabled fields are not submitted!)
        					?>
                            <input id="pagesize" name="pagesize[]" type="hidden" value="<?php echo $pagesize[$x] ?>" />
                            <?php } ?>

                    </td>
                    <td>
                        <?php print_string('pagesize', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <h4>
                            <?php print_string('auth_ldap_multi_bind_settings', 'auth_ldap_multi') ?>
                        </h4>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="menupreventpassindb"><?php print_string('auth_ldap_multi_preventpassindb_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $preventpassindb = json_decode($config->preventpassindb); ?>
                        <?php echo html_writer::select($yesno, 'preventpassindb[]', $preventpassindb[$x], false); ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_preventpassindb', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="bind_dn"><?php print_string('auth_ldap_multi_bind_dn_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $bind_dn = json_decode($config->bind_dn); ?>
                        <input name="bind_dn[]" id="bind_dn" type="text" class="text-ltr" size="30" value="<?php echo $bind_dn[$x] ?>" />
                        <?php if (isset($err['bind_dn'])) { echo $OUTPUT->error_text($err['bind_dn']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_bind_dn', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="bind_pw"><?php print_string('auth_ldap_multi_bind_pw_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $bind_pw = json_decode($config->bind_pw); ?>
                        <input name="bind_pw[]" id="bind_pw" type="password" class="text-ltr" size="30" value="<?php echo $bind_pw[$x] ?>" autocomplete="off"
                        />
                        <?php if (isset($err['bind_pw'])) { echo $OUTPUT->error_text($err['bind_pw']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_bind_pw', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <h4>
                            <?php print_string('auth_ldap_multi_user_settings', 'auth_ldap_multi') ?>
                        </h4>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="menuuser_type"><?php print_string('auth_ldap_multi_user_type_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $user_type = json_decode($config->user_type); ?>
                        <?php
            				echo html_writer::select(ldap_supported_usertypes(), 'user_type[]', $user_type[$x], false);
            				if (isset($err['user_type'])) { echo $OUTPUT->error_text($err['user_type']); }
        				?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_user_type', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="contexts"><?php print_string('auth_ldap_multi_contexts_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $contexts = json_decode($config->contexts); ?>
                        <input name="contexts[]" id="contexts" type="text" class="text-ltr" size="30" value="<?php echo $contexts[$x] ?>" />
                        <?php if (isset($err['contexts'])) { echo $OUTPUT->error_text($err['contexts']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_contexts', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="menusearch_sub"><?php print_string('auth_ldap_multi_search_sub_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $search_sub = json_decode($config->search_sub); ?>
                        <?php echo html_writer::select($yesno, 'search_sub[]', $search_sub[$x], false); ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_search_sub', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="menuopt_deref"><?php print_string('auth_ldap_multi_opt_deref_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                        <?php
                        	$opt_deref_value = json_decode($config->opt_deref);
							if(! is_array($opt_deref_value)){
								$opt_deref_value = [];
							}
                        	$opt_deref = array();
           					$opt_deref[LDAP_DEREF_NEVER] = get_string('no');
           					$opt_deref[LDAP_DEREF_ALWAYS] = get_string('yes');
							$opt_deref_value[$x] = isset($opt_deref_value[$x]) ?  $opt_deref_value[$x] : $opt_deref[LDAP_DEREF_NEVER];  
           					echo html_writer::select($opt_deref, 'opt_deref', $opt_deref_value[$x], false);
           					if (isset($err['opt_deref'])) { echo $OUTPUT->error_text($err['opt_deref']); }
        				?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_opt_deref', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="user_attribute"><?php print_string('auth_ldap_multi_user_attribute_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $user_attribute = json_decode($config->user_attribute); ?>
                        <input name="user_attribute[]" id="user_attribute" type="text" class="text-ltr" size="30" value="<?php echo $user_attribute[$x]?>"
                        />
                        <?php if (isset($err['user_attribute'])) { echo $OUTPUT->error_text($err['user_attribute']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_user_attribute', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="suspended_attribute"><?php print_string('auth_ldap_multi_suspended_attribute_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $suspended_attribute = json_decode($config->suspended_attribute); ?>
                        <input name="suspended_attribute[]" id="suspended_attribute" type="text" class="text-ltr" size="30" value="<?php echo $suspended_attribute[$x] ?>"
                        />
                        <?php if (isset($err['suspended_attribute'])) { echo $OUTPUT->error_text($err['suspended_attribute']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_suspended_attribute', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="memberattribute"><?php print_string('auth_ldap_multi_memberattribute_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $memberattribute = json_decode($config->memberattribute); ?>
                        <input name="memberattribute[]" id="memberattribute" type="text" class="text-ltr" size="30" value="<?php echo $memberattribute[$x]?>"
                        />
                        <?php if (isset($err['memberattribute'])) { echo $OUTPUT->error_text($err['memberattribute']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_memberattribute', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="memberattribute_isdn"><?php print_string('auth_ldap_multi_memberattribute_isdn_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $memberattribute_isdn = json_decode($config->memberattribute_isdn); ?>
                        <input name="memberattribute_isdn[]" id="memberattribute_isdn" type="text" class="text-ltr" size="30" value="<?php echo $memberattribute_isdn[$x]?>"
                        />
                        <?php if (isset($err['memberattribute_isdn'])) { echo $OUTPUT->error_text($err['memberattribute_isdn']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_memberattribute_isdn', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="objectclass"><?php print_string('auth_ldap_multi_objectclass_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $objectclass = json_decode($config->objectclass); ?>
                        <input name="objectclass[]" id="objectclass" type="text" class="text-ltr" size="30" value="<?php echo $objectclass[$x]?>"
                        />
                        <?php if (isset($err['objectclass'])) { echo $OUTPUT->error_text($err['objectclass']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_objectclass', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <h4>
                            <?php print_string('forcechangepassword', 'auth') ?>
                        </h4>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right" valign="top">
                        <label for="menuforcechangepassword"><?php print_string('forcechangepassword', 'auth') ?></label>
                    </td>
                    <td>
                    	<?php $forcechangepassword = json_decode($config->forcechangepassword); ?>
                        <?php echo html_writer::select($yesno, 'forcechangepassword[]', $forcechangepassword[$x], false); ?>
                    </td>
                    <td align="left" valign="top">
                        <p>
                            <?php print_string('forcechangepasswordfirst_help', 'auth') ?>
                        </p>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right" valign="top">
                        <label for="menustdchangepassword"><?php print_string('stdchangepassword', 'auth') ?></label>
                    </td>
                    <td>
                    	<?php $stdchangepassword = json_decode($config->stdchangepassword); ?>
                        <?php echo html_writer::select($yesno, 'stdchangepassword[]', $stdchangepassword[$x], false); ?>
                    </td>
                    <td align="left" valign="top">
                        <p>
                            <?php print_string('stdchangepassword_expl', 'auth') ?>
                        </p>
                        <p>
                            <?php print_string('stdchangepassword_explldap', 'auth') ?>
                        </p>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="menupasstype"><?php print_string('auth_ldap_multi_passtype_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                        <?php
                        	$passtype = json_decode($config->passtype);
							if( ! $passtype){
            					$passtype[$x] = null;
								
							}
            				$passtype['plaintext'] = get_string('plaintext', 'auth');
            				$passtype['md5']       = get_string('md5', 'auth');
            				$passtype['sha1']      = get_string('sha1', 'auth');
            				echo html_writer::select($passtype, 'passtype[]', $passtype[$x], false);
        				?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_passtype', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top">
                    <td align="right">
                        <label for="changepasswordurl"><?php print_string('auth_ldap_multi_changepasswordurl_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $changepasswordurl = json_decode($config->changepasswordurl); ?>
                        <input name="changepasswordurl[]" id="changepasswordurl" type="text" class="text-ltr" value="<?php echo $changepasswordurl[$x] ?>"
                        />
                        <?php if (isset($err['changepasswordurl'])) { echo $OUTPUT->error_text($err['changepasswordurl']); } ?>
                    </td>
                    <td>
                        <?php print_string('changepasswordhelp', 'auth') ?>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <h4>
                            <?php print_string('auth_ldap_multi_passwdexpire_settings', 'auth_ldap_multi') ?>
                        </h4>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="menuexpiration"><?php print_string('auth_ldap_multi_expiration_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                        <?php
                        	$expiration = json_decode($config->expiration);
           					$expiration = array();
           					$expiration['0'] = 'no';
           					$expiration['1'] = 'LDAP';
           					echo html_writer::select($expiration, 'expiration[]', $expiration[$x], false);
           					if (isset($err['expiration'])) { echo $OUTPUT->error_text($err['expiration']); }
        				?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_expiration_desc', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="expiration_warning"><?php print_string('auth_ldap_multi_expiration_warning_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $expiration_warning = json_decode($config->expiration_warning); ?>
                        <input name="expiration_warning[]" id="expiration_warning" type="text" class="text-ltr" size="2" value="<?php echo $expiration_warning[$x] ?>"
                        />
                        <?php if (isset($err['expiration_warning'])) { echo $OUTPUT->error_text($err['expiration_warning']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_expiration_warning_desc', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="expireattr"><?php print_string('auth_ldap_multi_expireattr_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $expireattr = json_decode($config->expireattr); ?>
                        <input name="expireattr[]" id="expireattr" type="text" class="text-ltr" size="30" value="<?php echo $expireattr[$x] ?>"
                        />
                        <?php if (isset($err['expireattr'])) { echo $OUTPUT->error_text($err['expireattr']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_expireattr_desc', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="menugracelogins"><?php print_string('auth_ldap_multi_gracelogins_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $gracelogins = json_decode($config->gracelogins); ?>
                        <?php echo html_writer::select($yesno, 'gracelogins[]', $gracelogins[$x], false); ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_gracelogins_desc', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="graceattr"><?php print_string('auth_ldap_multi_gracelogin_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $graceattr = json_decode($config->graceattr); ?>
                        <input name="graceattr[]" id="graceattr" type="text" class="text-ltr" size="30" value="<?php echo $graceattr[$x]?>" />
                        <?php if (isset($err['graceattr'])) { echo $OUTPUT->error_text($err['graceattr']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_graceattr_desc', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <h4>
                            <?php print_string('auth_user_create', 'auth') ?>
                        </h4>
                    </td>
                </tr>
                <tr valign="top">
                    <td align="right">
                        <label for="menuauth_user_create"><?php print_string('auth_ldap_multi_auth_user_create_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $auth_user_create = json_decode($config->auth_user_create); ?>
                        <?php echo html_writer::select($yesno, 'auth_user_create[]', $auth_user_create[$x], false); ?>
                    </td>
                    <td>
                        <?php print_string('auth_user_creation', 'auth'); ?>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="create_context"><?php print_string('auth_ldap_multi_create_context_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $create_context = json_decode($config->create_context); ?>
                        <input name="create_context[]" id="create_context" type="text" class="text-ltr" size="30" value="<?php echo $create_context[$x]?>"
                        />
                        <?php if (isset($err['create_context'])) { echo $OUTPUT->error_text($err['create_context']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_create_context', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <h4>
                            <?php print_string('coursecreators') ?>
                        </h4>
                    </td>
                </tr>
                <tr valign="top" class="required">
                    <td align="right">
                        <label for="creators"><?php print_string('auth_ldap_multi_creators_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $creators = json_decode($config->creators); ?>
                        <input name="creators[]" id="creators" type="text" class="text-ltr" size="30" value="<?php echo $creators [$x]?>" />
                        <?php if (isset($err['creators'])) { echo $OUTPUT->error_text($err['creators']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ldap_multi_creators', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <h4>
                            <?php print_string('auth_sync_script', 'auth') ?>
                        </h4>
                    </td>
                </tr>
                <tr valign="top">
                    <td align="right">
                        <label for="menuremoveuser"><?php print_string('auth_remove_user_key', 'auth') ?></label>
                    </td>
                    <td>
                        <?php
                        	$removeuser = json_decode($config->removeuser);
            				$deleteopt = array();
            				$deleteopt[AUTH_REMOVEUSER_KEEP] = get_string('auth_remove_keep', 'auth');
            				$deleteopt[AUTH_REMOVEUSER_SUSPEND] = get_string('auth_remove_suspend', 'auth');
            				$deleteopt[AUTH_REMOVEUSER_FULLDELETE] = get_string('auth_remove_delete', 'auth');
            				echo html_writer::select($deleteopt, 'removeuser[]', $removeuser[$x], false);
        				?>
                    </td>
                    <td>
                        <?php print_string('auth_remove_user', 'auth') ?>
                    </td>
                </tr>
                <tr valign="top">
                    <td align="right">
                        <label for="menusync_suspended"><?php print_string('auth_sync_suspended_key', 'auth') ?></label>
                    </td>
                    <td>
                    	<?php $sync_suspended = json_decode($config->sync_suspended); ?>
                        <?php echo html_writer::select($yesno, 'sync_suspended[]', $sync_suspended[$x], false); ?>
                    </td>
                    <td>
                        <?php print_string('auth_sync_suspended', 'auth'); ?>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <h4>
                            <?php print_string('auth_ntlmsso', 'auth_ldap_multi') ?>
                        </h4>
                    </td>
                </tr>
                <tr valign="top">
                    <td align="right">
                        <label for="menuntlmsso_enabled"><?php print_string('auth_ntlmsso_enabled_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $ntlmsso_enabled = json_decode($config->ntlmsso_enabled); ?>
                        <?php echo html_writer::select($yesno, 'ntlmsso_enabled[]', $ntlmsso_enabled[$x], false); ?>
                    </td>
                    <td>
                        <?php print_string('auth_ntlmsso_enabled', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top">
                    <td align="right">
                        <label for="ntlmsso_subnet"><?php print_string('auth_ntlmsso_subnet_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $ntlmsso_subnet = json_decode($config->ntlmsso_subnet); ?>
                        <input name="ntlmsso_subnet[]" id="ntlmsso_subnet" type="text" class="text-ltr" size="30" value="<?php p($ntlmsso_subnet[$x]) ?>"
                        />
                    </td>
                    <td>
                        <?php print_string('auth_ntlmsso_subnet', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top">
                    <td align="right">
                        <label for="menuntlmsso_ie_fastpath"><?php print_string('auth_ntlmsso_ie_fastpath_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $ntlmsso_ie_fastpath = json_decode($config->ntlmsso_ie_fastpath); ?>
                        <?php echo html_writer::select($fastpathoptions, 'ntlmsso_ie_fastpath[]', $ntlmsso_ie_fastpath[$x], false); ?>
                    </td>
                    <td>
                        <?php print_string('auth_ntlmsso_ie_fastpath', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top">
                    <td align="right">
                        <label for="menuntlmsso_type"><?php print_string('auth_ntlmsso_type_key', 'auth_ldap_multi')?></label>
                    </td>
                    <td>
                        <?php
                        	$ntlmsso_type = json_decode($config->ntlmsso_type);
            				$types = array();
            				$types['ntlm'] = 'NTLM';
            				$types['kerberos'] = 'Kerberos';
            				echo html_writer::select($types, 'ntlmsso_type[]', $ntlmsso_type[$x], false);
        				?>
                    </td>
                    <td>
                        <?php print_string('auth_ntlmsso_type','auth_ldap_multi') ?>
                    </td>
                </tr>
                <tr valign="top">
                    <td align="right">
                        <label for="ntlmsso_remoteuserformat"><?php print_string('auth_ntlmsso_remoteuserformat_key', 'auth_ldap_multi') ?></label>
                    </td>
                    <td>
                    	<?php $ntlmsso_remoteuserformat = json_decode($config->ntlmsso_remoteuserformat); ?>
                        <input name="ntlmsso_remoteuserformat[]" id="ntlmsso_remoteuserformat" type="text" class="text-ltr" size="30" value="<?php echo $ntlmsso_remoteuserformat[$x]?>"
                        />
                        <?php if (isset($err['ntlmsso_remoteuserformat'])) { echo $OUTPUT->error_text($err['ntlmsso_remoteuserformat']); } ?>
                    </td>
                    <td>
                        <?php print_string('auth_ntlmsso_remoteuserformat', 'auth_ldap_multi') ?>
                    </td>
                </tr>
                <?php
					$help  = get_string('auth_ldap_multi_extrafields', 'auth_ldap_multi');
					$help .= get_string('auth_updatelocal_expl', 'auth');
					$help .= get_string('auth_fieldlock_expl', 'auth');
					$help .= get_string('auth_updateremote_expl', 'auth');
					$help .= '<hr />';
					$help .= get_string('auth_updateremote_ldap', 'auth');

					print_auth_lock_options($this->authtype, $user_fields, $help, true, true, $this->get_custom_user_profile_fields());
				?>
            </table>
        </div>
        <div id="test-connection<?=$x?>">
        	<?php
        		$parameters = ['id' => $x];
        		$url = $PAGE->url->out(false, $parameters);
				
        	?>
        	<a href="<?=$url?>">Testar Conexão</a> | 
        	<a href="#" class="remove" id="<?=$x?>">Remover Servidor</a>
       	</div>
        <?php endfor; ?>
      </div>
    <hr>
    <div class="add-new"><button type="button" id="new-server">Novo Servidor</button></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        $(".container").on("click",".header", function() {
			console.log(1);
            $header = $(this);
            //getting the next element
            $content = $header.next();
            //open up the content needed - toggle the slide- if visible, slide up, if not slidedown.
            $content.slideToggle(500, function () {
                //execute this after slideToggle is done
                //change text of header based on visibility of content div
                $header.text(function () {       //change text based on condition
                	//return $content.is(":visible") ? "Collapse" : "Expand";
                    return $content.is(":visible") ? "LDAP server settings -" : "LDAP server settings +";
                });
            });

        });

        $("#new-server").click(function(){
        	var cloneIndex = $(".header").length;
        	var header  = $('#header0').clone().attr("id", "header" +  cloneIndex);
        	var content = $('#content0').clone().attr("id", "content" + cloneIndex);
        	var test_connection = $('#test-connection0').clone().attr("id", "test-connection" + cloneIndex);
        	console.log(header);
        	$(".container").append(header);
        	$(".container").append(content);
        	$(".container").append(test_connection);
        	
        });
        
        $(".container").on("click", ".remove", function(){
        	id = $(this).attr("id");
        	$("#header" + id).remove();
        	$("#content" + id).remove();
        	$("#test-connection" + id).remove();
        	$( "#authmenu" ).submit();
        });

    </script>